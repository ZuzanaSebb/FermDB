<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Fermentation: A Pickled Project</title>
    <meta name="description" content="Fermentation: A Pickled Project" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
</head>
<body>
<main>
    <div id="map-section" class="col-md-12" style="height: 100%; width:100%; position: absolute; z-index: 1;">
                <div class="row" id = "map1" style="visibility: inherit; height: 80vh; width: 100%; padding-left: 10px; padding-left: 10px">
                    <!-- LEFT -->
                    <div class="col-6">
                        <div class="col">
                            <!-- category selector -->
                            <div class="row legendSVG" id = "mapCategories" style="height: 10vh; padding-left: 10px">
                                <select id='categorySelector' class="custom-form custom-select align-self-center " style="width: 40%" onchange="categoryChange()">
                                    <option value="all" selected >All</option>
                                    <option value="alcoholic beverage" >alcoholic beverage</option>
                                    <option value="fermented cereal" >fermented cereal</option>
                                    <option value="cheese">cheese</option>
                                    <option value="wine">wine</option>
                                    <option value="beer">beer</option>
                                    <option value="yogurt">yogurt</option>
                                    <option value="fermented vegetables">fermented vegetables</option>
                                    <option value="dairy product">dairy product</option>
                                    <option value="fermented roots">fermented roots</option>
                                    <option value="fermented fish">fermented fish</option>
                                    <option value="fermented fruit">fermented fruit</option>
                                    <option value="condiment">condiment</option>
                                    <option value="other">other</option>
                                    <option value="Yoghurt">Yoghurt</option>

                                    <option value="fermented legumes">fermented legumes</option>

                                    <option value="fermented meat">fermented meat</option>
                                </select>
                            </div>

                            <div class = "container">
                                <!-- mapVis -->
                                <div class="row" style="height: 60vh;">
                                    <div id="mapDiv"
                                         style="height: 100%; width:100%;">
                                    </div>
                                </div>

                                <!-- barplotVis -->
                                <div class = "row" style = "height: 30vh; width: 100%; position: absolute; z-index: 20">
                                    <div id="barplotDiv"
                                         style="height: 100%; width:100%;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT -->

                    <!-- text description that goes away when dendro is clicked -->
                    <div class="col-6" style = "height: 100vh; padding-top: 2vh; padding-bottom: 1vh" >
                        <div class="row" style="height: 100vh;">
                            <div id="dendroDiv"
                                 style="height: 100%; width:100%;">
                            </div>
                        </div>
                    </div>
            </div>

    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>

<script>
class MapVis {
    constructor(parentElement, dataTopographic, fermData) {
        this.parentElement = parentElement;
        this.dataTopographic = dataTopographic;
        this.fermData = fermData;
        this.initVis()
    }

    initVis() {
        let vis = this;

        vis.margin = {top: 0, right: 0, bottom: 0, left: 0};
        vis.width = document.getElementById(vis.parentElement).getBoundingClientRect().width - vis.margin.left - vis.margin.right;
        vis.height = document.getElementById(vis.parentElement).getBoundingClientRect().height - vis.margin.top - vis.margin.bottom;

        vis.legendSVG = d3.select(".legendSVG").append("svg")
            .attr("width", vis.width/2)
            .attr("height", "9vh")
            .attr('transform', `translate (${vis.margin.left}, ${vis.margin.top})`);

        // init drawing area
        vis.svg = d3.select("#" + vis.parentElement).append("svg")
            .attr("width", vis.width)
            .attr("height", vis.height)
            .attr('transform', `translate (${vis.margin.left}, ${vis.margin.top})`);

        vis.viewpoint = {'width': 975, 'height': 610};
        vis.zoom = vis.width / (vis.viewpoint.width);

        // vis.projection = d3.geoOrthographic()
        vis.projection = d3.geoEqualEarth()
            .translate([vis.width / 2, vis.height / 2])
            .scale(170);

        // Define a geogenerator and pass the projection
        vis.path = d3.geoPath()
            .projection(vis.projection);

        // Convert TopoJSON into GeoJSON
        vis.world = topojson.feature(vis.dataTopographic, vis.dataTopographic.objects.countries).features;

        // Add the "water" before the countries
        vis.svg.append("path")
            .datum({type: "Sphere"})
            .attr("class", "graticule")
            .attr('fill', 'rgba(130, 203, 210, 0.6)')
           // .attr('fill', '#8db9c7')
            .attr("opacity", "0.5")
            .attr("stroke","rgba(0,0,0,0.35)")
            .attr("d", vis.path);

        // Draw countries
        vis.countries = vis.svg.selectAll(".country")
            .data(vis.world)
            .enter().append("path")
            .attr("class", d => `${d.properties.name.replaceAll(' ', '-')}-country country`)
            .attr("d", vis.path);

        // Make the map draggable
        let m0,
            o0;

        vis.svg.call(
            d3.drag()
                .on("start", function (event) {
                    let lastRotationParams = vis.projection.rotate();
                    m0 = [event.x, event.y];
                    o0 = [-lastRotationParams[0], -lastRotationParams[1]];
                })
                .on("drag", function (event) {
                    if (m0) {
                        let m1 = [event.x, event.y],
                            o1 = [o0[0] + (m0[0] - m1[0]) / 4, o0[1] + (m1[1] - m0[1]) / 4];
                        vis.projection.rotate([-o1[0], -o1[1]]);
                    }

                    // Update the map
                    vis.path = d3.geoPath().projection(vis.projection);
                    d3.selectAll(".country").attr("d", vis.path)
                    d3.selectAll(".graticule").attr("d", vis.path)
                })
        )

        /* * * * * * * Tooltip * * * * * * */
        // append tooltip
        vis.tooltip = d3.select("body").append('div')
            .attr('class', "tooltip")
            .attr('id', 'globeTooltip')

        vis.colorScale = d3.scaleLinear()
            .range(["#FCF5E5", "#B87333"])

        /* * * * * * * instantiate legend * * * * * * */
        vis.colormapWidth = vis.width /3;
        vis.colormapHeight = 25;

        // Create an axis scale
        vis.axisScale = d3.scaleLinear()
            .range([0, vis.colormapWidth]);

        // Create and append the axis to the SVG
        vis.axis = d3.axisBottom(vis.axisScale)
            .tickFormat(d3.format('d'));

        vis.wrangleData()
    }

    wrangleData() {
        let vis = this
        let fermByCountry = Array.from(d3.group(vis.fermData, d => d.Country), ([key, value]) => ({key, value}))

        // init final data structure in which both data sets will be merged into
        vis.countryInfo = []
        vis.selectableFoods = []

        vis.world.forEach(function(d, index) {
            let fermsOfThisCat = 0;
            let allFerms = 0;

            let currName = d.properties.name;

            let currCountry = fermByCountry.filter((x) => {
                return x.key === currName;
            })[0];

            if (currCountry == null) {
                // populate the final data structure
                vis.countryInfo.push(
                    {
                        country: currName,
                        allFerms: allFerms,
                        fermsOfThisCat: fermsOfThisCat,
                    }
                )
            }
            else if (selectedFood === "all"){
                currCountry.value.forEach(food => {
                    allFerms += 1;
                    fermsOfThisCat += 1;
                    vis.selectableFoods.push(
                        food
                    )
                })
                vis.countryInfo.push(
                    {
                        country: currName,
                        allFerms: allFerms,
                        fermsOfThisCat: fermsOfThisCat,
                    }
                )
            }

            else {
                currCountry.value.forEach(food => {
                    if (food.Category == selectedFood) {
                        //console.log(food.Category, selectedFood)
                        allFerms += 1;
                        fermsOfThisCat += 1;
                        vis.selectableFoods.push(
                            food
                        )
                    } else {
                        allFerms += 1;
                    }
                })

                vis.countryInfo.push(
                    {
                        country: currName,
                        allFerms: allFerms,
                        fermsOfThisCat: fermsOfThisCat,
                    }
                )
            }
        })

        vis.updateVis()
    }

    updateVis() {
        let vis = this;

        // update color scale
        let currMax = d3.max(vis.countryInfo, d => d.fermsOfThisCat);
        vis.colorScale.domain([0,currMax]);

        // color countries
        vis.countries
            .transition()
            .duration(1000)
            .attr("fill", d => {
                // console.log(d.properties.name)
                let countryName = d.properties.name;
                let color = " ";

                vis.countryInfo.forEach(country =>{
                    if (countryName === country.country){
                        if (country.allFerms === 0){
                            color = "#DCDCDC"
                        }
                        else{
                            color = vis.colorScale(country.fermsOfThisCat)
                        }
                    }
                })

                return color
            })


        vis.countries
            .style('stroke-width', '2px')  // Use style instead of attr for stroke-width
            .style("stroke", "rgba(0,0,0,0.25)")  // Adjust the stroke color as needed
            // highlight on mouseover and link bar
            .on('mouseover', function(event, d){
                selectedCountry = d.properties.name;

                let currData = []

                vis.countryInfo.forEach(country =>{
                    if (selectedCountry === country.country){
                        currData = country
                    }
                })

                d3.selectAll(`.${selectedCountry.replaceAll(' ', '-')}-country`)
                    .attr("fill", d => {

                        let color = " ";

                        vis.countryInfo.forEach(country =>{
                            if (selectedCountry === country.country){
                                color = vis.colorScale(country.fermsOfThisCat)
                            }
                        })

                        /*                        if(typeof color !== "undefined")
                                                {
                                                    vis.hovColor = color
                                                }*/

                        if (currData.allFerms !== 0){
                            return 'rgb(130, 203, 210)'
                        }
                        else{
                            return '#DCDCDC'
                        }
                    })

                vis.tooltip
                    .style("opacity", 1)
                    .style("left", event.pageX + 20 + "px")
                    .style("top", event.pageY + "px")
                    .html(
                        `
                     <div >
                     <h3> ${currData.country}<h3>
                     <h4> Number of ${selectedFood}: ${currData.fermsOfThisCat}</h4>
                     </div>\`
                     </div>`
                    );
                if (selectedFood === "all"){
                    vis.tooltip
                        .html(
                            `
                     <div >
                     <h3> ${currData.country}<h3>
                     <h4> Total Products: ${currData.allFerms}</h4>
                     </div>\`
                     </div>`
                        )
                }
                if (currData.allFerms === 0){
                    vis.tooltip
                        .style("opacity", 0)
                }
            })

            // set the color back to what it was
            .on('mouseout', function(event, d){
                d3.selectAll(`.${selectedCountry.replaceAll(' ', '-')}-country`)
                    .attr("fill", d => {
                        let countryName = selectedCountry;
                        let color = " ";

                        vis.countryInfo.forEach(country =>{
                            if (countryName === country.country){
                                if (country.allFerms === 0){
                                    color = "#DCDCDC"
                                }
                                else{
                                    color = vis.colorScale(country.fermsOfThisCat)
                                }
                            }
                        })

                        return color
                    })

                // empty the tooltip
                vis.tooltip
                    .style("opacity", 0)
                    .style("left", 0)
                    .style("top", 0)
                    .html(``);
            })

            // update dendro on click
            .on('click', function(event,d){
                selectedCountryLink = d.properties.name;
                // let seeDendro = document.getElementById("hidingDendro");
                // seeDendro.removeAttribute("hidden");

                // let hideText = document.getElementById("hideExplanation")
                // hideText.setAttribute("hidden", "hidden");
                myDendroVis.wrangleData();
            })

        // Generate a series of color stops to represent the colormap
        const colorStops = d3.range(0, currMax, currMax/50);

        vis.legend = vis.legendSVG.append("g")
            .attr('class', 'legend')
            .attr('transform', `translate(${100}, ${25 })`)

        vis.legendSVG.append("g")
            .attr('class', 'x-axis')
            .style("font-family", "Poppins")
            .style("font-size", "1em")
            .attr("transform", `translate(${100}, ${50})`);

        // Draw the colormap
        vis.legend.selectAll("rect")
            .data(colorStops)
            .enter()
            .append("rect")
            .attr("x", (d, i) => i * (vis.colormapWidth / colorStops.length))
            .attr("y", 0)
            .attr("width", vis.colormapWidth / colorStops.length)
            .attr("height", vis.colormapHeight)
            .attr("fill", d => vis.colorScale(d));

        // call axes
        vis.axisScale.domain([1, currMax])
        vis.axis.scale(vis.axisScale);
        vis.legendSVG.select(".x-axis").transition().duration(1000).call(vis.axis);
    }
}
</script>
<script>/* * * * * * * * * * * * * *
    *      class mapBarVis     *
    * * * * * * * * * * * * * */
    
    class mapBarVis {
        constructor(parentElement, dataTopographic, fermData){
            this.parentElement = parentElement;
            this.dataTopographic = dataTopographic;
            this.fermData = fermData;
            this.initVis()
        }
    
        initVis(){
            let vis = this;
    
            vis.margin = {top: 10, right: 40, bottom: 40, left: 30};
            vis.width = document.getElementById(vis.parentElement).getBoundingClientRect().width - vis.margin.left - vis.margin.right;
            vis.height = document.getElementById(vis.parentElement).getBoundingClientRect().height - vis.margin.top - vis.margin.bottom;
    
            // init drawing area
            vis.svg = d3.select("#" + vis.parentElement).append("svg")
                .attr("width", vis.width + vis.margin.left + vis.margin.right)
                .attr("height", vis.height + vis.margin.top + vis.margin.bottom)
                .append('g')
                .attr('transform', `translate (${vis.margin.left}, ${vis.margin.top})`);
    
            // tooltip
            vis.tooltip = d3.select("body").append('div')
                .attr('class', "tooltip")
                .attr('id', 'barTooltip')
    
            vis.world = topojson.feature(vis.dataTopographic, vis.dataTopographic.objects.countries).features;
    
            // scales for color
            vis.x = d3.scaleBand()
                .range([0, vis.width])
                .paddingInner (0.1);
    
            vis.y = d3.scaleLinear()
                .range([vis.height, 0])
    
            vis.colorScale = d3.scaleLinear()
                .range(["#FCF5E5", "#B87333"])
    
            // init axes
            vis.xAxis = d3.axisBottom(vis.x)
            vis.yAxis = d3.axisLeft(vis.y)
    
            // create groups
            vis.svg.append("g")
                .attr("class", "x-axis axis")
                .style("font-family", "Poppins")
                .style("font-size", ".8em")
                .attr("transform", "translate(0," + vis.height + ")")
                .call(vis.xAxis);
    
            vis.svg.append("g")
                .attr("class", "y-axis axis")
                .style("font-size", "1em")
                .style("font-family", "Poppins")
                .call(vis.yAxis);
    
            vis.wrangleData();
        }
    
        wrangleData() {
            // same wrangleData as mapVis, since linked
            let vis = this
    
            let fermByCountry = Array.from(d3.group(vis.fermData, d => d.Country), ([key, value]) => ({key, value}))
    
            // init final data structure in which both data sets will be merged into
            vis.countryInfo = []
            vis.selectableFoods = []
    
            vis.world.forEach(function(d, index) {
                let fermsOfThisCat = 0;
                let allFerms = 0;
    
                let currName = d.properties.name;
    
                let currCountry = fermByCountry.filter((x) => {
                    return x.key === currName;
                })[0];
    
                if (currCountry == null) {
                    // populate the final data structure
                    vis.countryInfo.push(
                        {
                            country: currName,
                            allFerms: allFerms,
                            fermsOfThisCat: fermsOfThisCat,
                        }
                    )
                }
                else if (selectedFood === "all"){
                    currCountry.value.forEach(food => {
                        allFerms += 1;
                        fermsOfThisCat += 1;
                        vis.selectableFoods.push(
                            food
                        )
                    })
                    vis.countryInfo.push(
                        {
                            country: currName,
                            allFerms: allFerms,
                            fermsOfThisCat: fermsOfThisCat,
                        }
                    )
                }
    
                else {
                    currCountry.value.forEach(food => {
                        if (food.Category == selectedFood) {
                            //console.log(food.Category, selectedFood)
                            allFerms += 1;
                            fermsOfThisCat += 1;
                            vis.selectableFoods.push(
                                food
                            )
                        } else {
                            allFerms += 1;
                        }
                    })
    
                    vis.countryInfo.push(
                        {
                            country: currName,
                            allFerms: allFerms,
                            fermsOfThisCat: fermsOfThisCat,
                        }
                    )
    
                }
            })
    
            // get the top eight countries
            vis.countryInfo.sort((a,b) => {return b.fermsOfThisCat - a.fermsOfThisCat})
    
            vis.topEightData = vis.countryInfo.slice(0, 8)
    
            vis.updateVis()
    
        }
    
        updateVis(){
            let vis = this;
    
            // update domains
            vis.x.domain(vis.topEightData.map(d => d.country));
            vis.y.domain([0, d3.max(vis.topEightData, d => d.fermsOfThisCat)]);
    
            // update color scale
            vis.colorScale.domain([0, d3.max(vis.countryInfo, d => d.fermsOfThisCat)]);
    
            // append bars
            vis.bars = vis.svg.selectAll('rect')
                .data(vis.topEightData, d => d.country);
    
            vis.bars.enter()
                .append('rect')
                .merge(vis.bars)
    
                // highlight bars on mouseover and linked countries
                .on("mouseover", function(event, d) {
                    selectedCountry = d.country;
                    let currData = []
    
                    vis.countryInfo.forEach(country =>{
                        if (selectedCountry === country.country){
                            currData = country
                        }
                    })
    
                    d3.selectAll(`.${selectedCountry.replaceAll(' ', '-')}-country`)
                        .attr("fill", d => {
                            let color = " ";
    
                            vis.countryInfo.forEach(country =>{
                                if (selectedCountry === country.country){
                                    color = vis.colorScale(country.fermsOfThisCat)
                                }
                            })
    
                            if (currData.allFerms !== 0){
                                return 'rgb(130, 203, 210)'
                            }
                            else{
                                return '#DCDCDC'
                            }
                        })
    
                    vis.tooltip
                        .style("opacity", 1)
                        .style("left", event.pageX + 20 + "px")
                        .style("top", event.pageY + "px")
                        .html(
                            `
                         <div>
                         <h3> ${currData.country}<h3>
                         <h4> Number of ${selectedFood}: ${currData.fermsOfThisCat}</h4>
                         </div>\`
                         </div>`
                        );
    
                    if (selectedFood === "all"){
                        vis.tooltip
                            .html(
                                `
                         <div >
                         <h3> ${currData.country}<h3>
                         <h4> Total Products: ${currData.allFerms}</h4>
                         </div>\`
                         </div>`
                            )
                    }
                    if (currData.allFerms === 0){
                        vis.tooltip
                            .style("opacity", 0)
                    }
                })
    
                // set the color back to what it was
                .on('mouseout', function(event, d){
                    selectedCountry = d.country;
    
                    d3.selectAll(`.${selectedCountry.replaceAll(' ', '-')}-country`)
                        .attr("fill", d => {
                            let countryName = selectedCountry;
                            let color = " ";
    
                            vis.countryInfo.forEach(country =>{
                                if (countryName === country.country){
                                    if (country.allFerms === 0){
                                        color = "#DCDCDC"
                                    }
                                    else{
                                        color = vis.colorScale(country.fermsOfThisCat)
                                    }
                                }
                            })
    
                            return color
                        })
    
                    // empty the tooltip
                    vis.tooltip
                        .style("opacity", 0)
                        .style("left", 0)
                        .style("top", 0)
                        .html(``);
                })
    
                // on click, update dendrogram and make sure text hidden
                .on('click', function(event,d){
                    selectedCountryLink = d.country;
                    myDendroVis.wrangleData();
                })
                .transition()
                .duration(1000)
                .attr("class", d => {
                    return `${d.country.replaceAll(' ', '-')}-country`
                })
                .attr("x", d => vis.x(d.country))
                .attr("y", d => vis.y(d.fermsOfThisCat))
                .attr("width", vis.x.bandwidth())
                .attr("height", d => vis.height - vis.y(d.fermsOfThisCat))
                .attr("fill", d => vis.colorScale(d.fermsOfThisCat));
    
            vis.bars.exit().remove()
    
            vis.svg.select(".y-axis").transition().duration(500).call(vis.yAxis);
            vis.svg.select(".x-axis").transition().duration(500).call(vis.xAxis);
    
            vis.svg.select(".x-axis")
                .transition()
                .duration(500)
                .call(vis.xAxis)
                .selectAll("text")
                .style("text-anchor", "middle");
        }
    }
</script>
<script>
 /* * * * * * * * * * * * * *
*      class dendroVis     *
* * * * * * * * * * * * * */
class dendroVis {
    constructor(parentElement, dataDendro) {
        this.parentElement = parentElement;
        this.dataDendro = dataDendro;

        this.initVis()
    }

    initVis() {
        let vis = this;

        vis.margin = {top: 0, right: 10, bottom: 20, left: 10};
        vis.width = document.getElementById(vis.parentElement).getBoundingClientRect().width - vis.margin.left - vis.margin.right;
        vis.height = document.getElementById(vis.parentElement).getBoundingClientRect().height - vis.margin.top - vis.margin.bottom;

        // init drawing area
        vis.space = d3.select("#" + vis.parentElement).append("svg")
            .attr("width", vis.width)
            .attr("height", vis.height)
            .attr('transform', `translate (${vis.margin.left}, ${vis.margin.top})`);

        vis.g = vis.space.append("g").attr("transform", "translate(60,0)");


        // prepare functions for data later
        vis.cluster = d3.cluster()
            .size([vis.height, vis.width - vis.width/3]);

        vis.stratify = d3.stratify()
            .parentId(function(d) { return d.id.substring(0, d.id.lastIndexOf(".")); });


        selectedCountryLink = "India";
        vis.wrangleData()
    }

    wrangleData() {
        let vis = this;

        vis.filteredData1 = vis.dataDendro.filter((word) => word.id.startsWith(selectedCountryLink))

        // filter data for category
        if (selectedFood === "all") {
            vis.filteredData = vis.filteredData1
        } else {
            vis.filteredData = vis.filteredData1.filter((word) => word.id.includes(selectedFood))
            vis.filteredData.push({id: selectedCountryLink})
        }

        // prepare data for dendrogram
        vis.root = vis.stratify(vis.filteredData)
            .sort(function (a, b) {
                return (a.height - b.height) || a.id.localeCompare(b.id);
            });

        // clear drawing area for next selection
        vis.g.selectAll(".link")
            .remove()
        vis.g.selectAll(".node")
            .remove()
        vis.g.selectAll(".text-node")
            .remove()
        vis.space.selectAll(".dendroTitleText")
            .remove()
        vis.space.selectAll(".dendroSubText")
            .remove()
        vis.space.selectAll(".dendroNoText")
            .remove()

        // append text for selected country and category
        vis.space.append("text")
            .attr("class", "dendroTitleText")
            .attr("x", vis.width / 20)
            .attr("dy", "0em")
            .attr("y", "4vh")
            .attr("background-color", "#FCF5E5")
            .style("text-anchor", "left")
            .text(selectedCountryLink)

        vis.space.append("text")
            .attr("class", "dendroSubText")
            .attr("x", vis.width / 20)
            .attr("y", "4vh")
            .attr("dy", "1.5em")
            .attr("background-color", "#FCF5E5")
            .style("text-anchor", "left")
            .text(selectedFood)

        // draw vis
        vis.updateVis()
    }

    updateVis() {
        let vis = this;

        // catch exception if country doesn't have data otherwise draw dendrogram
        if (vis.filteredData.length === 1) {
            vis.space.append("text")
                .attr("class", "dendroNoText")
                .attr("x", vis.width / 20)
                .attr("y", vis.height / 2)
                .attr("background-color", "#FCF5E5")
                .style("text-anchor", "left")
                .text("No recorded fermented foods in this sub-category.")

        } else {
            vis.cluster(vis.root);

            vis.link = vis.g.selectAll(".link")
                .data(vis.root.descendants().slice(1));

            vis.link.enter()
                .append("path")
                .attr("class", "link")
                .attr("d", diagonal);

            vis.node = vis.g.selectAll(".node")
                .data(vis.root.descendants())

            vis.node.enter()
                .append("g")
                .attr("class", function (d) {
                    return "node" + (d.children ? " node--internal" : " node--leaf");
                })
                .attr("transform", function (d) {
                    return "translate(" + (d.y - 25) + "," + d.x + ")";
                })
                .append("circle")
                .attr("r", 4);

            vis.node.enter()
                .append("text")
                .attr("class", "text-node")
                .attr("transform", function (d) {
                    return "translate(" + (d.y - 25) + "," + d.x + ")";
                })
                .attr("dy", 3)
                .attr("background-color", "#FCF5E5")
                .attr("x", function (d) {
                    return d.children ? -10 : 5;
                })
                .style("text-anchor", function (d) {
                    return d.children ? "end" : "start";
                })
                .text(function (d) {
                    if (d.id.substring(d.id.lastIndexOf(".") + 1) === selectedCountryLink) {
                        return (" ")
                    } else {
                        return d.id.substring(d.id.lastIndexOf(".") + 1);
                    }
                });

            function diagonal(d) {
                return "M" + (d.y - 25) + "," + d.x
                    + "C" + (d.parent.y + 100) + "," + d.x
                    + " " + (d.parent.y + 100) + "," + d.parent.x
                    + " " + (d.parent.y - 25) + "," + d.parent.x;
            }

        }
    }
}   
</script>
<script>
/* * * * * * * * * * * * * *
*           MAIN           *
* * * * * * * * * * * * * */

// init global variables & switches
let myMapVis,
    myBarVisOne,
    categoryNames,
    myDendroVis;

let mode = 'beg';
// grab selected category of foods for mapVis
let selectedFood = d3.select("#categorySelector").property("value");
let selectedCountry = '';


// load data
let promises = [
    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json"), // 0
    d3.csv("Map_category.csv"), // 1
    d3.csv("DendrogramData.csv"), // 2
];

Promise.all(promises)
    .then(function (data) {
        categoryNames = [... new Set(data[1].map(row => row.Category))];

        initMainPage(data)
    })
    .catch(function (err) {
        console.log(err)
    });

// // dictionary to help naming
// let categoryNames = {
//     "all": "All Categories of Fermented Foods",
//     "fruits and vegetables": "Fermented Fruits and Vegetables",
//     "roots and legumes": "Fermented Roots and Legumes",
//     "cereal": "Fermented Cereals",
//     "cheese": "Fermented Cheese",
//     "meat": "Fermented Meats",
//     "dairy product": "Fermented Dairy Products",
//     "legumes": "Fermented Legumes",
//     "roots": "Fermented Roots",
//     "beverage": "Fermented Beverages",
//     "vegetables": "Fermented Vegetables",
//     "fish": "Fermented Fish",
//     "fruit": "Fermented Fruit"
// };

// when category of food changes, update for mapVis, dendroVis, and mapBarVis
function categoryChange() {
    selectedFood =  document.getElementById('categorySelector').value;
    myMapVis.wrangleData();
    myBarVisOne.wrangleData();
    myDendroVis.wrangleData();
}

// initMainPage
function initMainPage(dataArray) {
    // console.log('check out the data', dataArray);
    selectedCountryLink = '';

    // init map
    myMapVis = new MapVis('mapDiv', dataArray[0], dataArray[1]);
    // init top 10 graph
    myBarVisOne = new mapBarVis('barplotDiv',  dataArray[0], dataArray[1]);
    // init dendrogram
    myDendroVis = new dendroVis('dendroDiv', dataArray[2]);
}
</script>
</body>

</html>
